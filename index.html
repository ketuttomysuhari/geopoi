<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SIGEO AI • POI Generator from OSM Buildings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Mapbox v3.15.0 (punya setRain, walau belum dipakai di versi ini) -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.js"></script>
  <!-- Turf for geoprocessing -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
  <!-- SheetJS for XLSX import/export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #map{position:absolute;inset:0}
    .panel{
      position:absolute; z-index:10; right:12px; top:12px; width:360px; max-width:calc(100% - 24px);
      background:rgba(20,20,24,.95); color:#fff; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,.25);
      display:flex; flex-direction:column; overflow:hidden;
    }
    .panel-h{padding:10px 12px;font-weight:700;border-bottom:1px solid rgba(255,255,255,.08);display:flex;justify-content:space-between;align-items:center}
    .panel-b{padding:12px; font-size:13px}
    .row{display:flex; gap:8px; flex-wrap:wrap; margin:8px 0}
    .row > * { flex:1 }
    .btn{
      appearance:none; border:none; border-radius:8px; padding:8px 10px; font-weight:700; cursor:pointer;
      background:#22c55e; color:#052e16;
    }
    .btn.secondary{ background:#0ea5e9; color:#03202a }
    .btn.warn{ background:#ef4444; color:#2d0707 }
    .btn.dark{ background:#374151; color:#d1d5db }
    .stat{display:flex; gap:12px; align-items:center; margin:6px 0}
    .stat b{font-size:16px}
    .hint{opacity:.85}
    table{width:100%; border-collapse:collapse; margin-top:8px; font-size:12px}
    th,td{border-bottom:1px solid rgba(255,255,255,.08); padding:6px 4px; text-align:left; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    th{opacity:.8}
    .small{font-size:11px; opacity:.8}
    .file{display:inline-block; padding:8px; border:1px dashed rgba(255,255,255,.2); border-radius:8px; text-align:center}
    .badge{display:inline-block; padding:2px 6px; border-radius:6px; background:#0ea5e9; color:#03202a; font-weight:700; font-size:11px}
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <div class="panel-h">
      <span>SIGEO AI — POI Generator</span>
      <span class="badge" id="viewInfo">view: 0×0</span>
    </div>
    <div class="panel-b">
      <div class="stat">
        <div>Total POI:</div>
        <b id="poiCount">0</b>
      </div>

      <div class="row">
        <button class="btn" id="genPoiBtn">Generate POI from OSM Buildings (in view)</button>
      </div>

      <div class="row">
        <button class="btn secondary" id="expXlsxBtn">Export XLSX</button>
        <button class="btn secondary" id="expCsvBtn">Export CSV</button>
        <button class="btn secondary" id="expGeoJsonBtn">Export GeoJSON</button>
      </div>

      <div class="row" style="align-items:center">
        <label class="file" style="flex:2">
          Import XLSX
          <input type="file" id="impXlsxInput" accept=".xlsx,.xls" style="display:none">
        </label>
        <button class="btn dark" id="clearBtn" style="flex:1">Clear POI</button>
      </div>

      <div class="hint small">Tips: Zoom dan geser peta ke area target, lalu klik “Generate POI…”. Ulangi di area lain; POI akan ditambahkan (duplikat otomatis disaring berdasarkan lon-lat).</div>

      <div style="margin-top:10px; font-weight:700">Preview (top 10)</div>
      <table id="poiTable">
        <thead>
          <tr>
            <th>#</th><th>Name</th><th>Type</th><th>Height</th><th>Lon</th><th>Lat</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
/* =========================
   MAPBOX SETUP
   ========================= */
mapboxgl.accessToken = 'pk.eyJ1Ijoia2V0dXR0b215c3VoYXJpIiwiYSI6ImNrZmdvOWNvazBtM3EycmxkcHF3eXc0OTgifQ.J6kVGmohIIwY-A0hmt0gtg';
const PETRONAS = [101.71186, 3.15776];

const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/standard',
  center: PETRONAS,
  zoom: 17.2,
  pitch: 72,
  bearing: 20,
  antialias: true,
  hash: true
});
map.addControl(new mapboxgl.NavigationControl({ visualizePitch:true }), 'top-right');
map.addControl(new mapboxgl.FullscreenControl(), 'top-right');
map.addControl(new mapboxgl.ScaleControl({ maxWidth: 120, unit: 'metric' }));

map.on('style.load', () => {
  // Terrain + sky (opsional, membuat 3D nyaman)
  try {
    if (!map.getSource('mapbox-dem')) {
      map.addSource('mapbox-dem',{ type:'raster-dem', url:'mapbox://mapbox.mapbox-terrain-dem-v1', tileSize:512 });
    }
    map.setTerrain({ source:'mapbox-dem', exaggeration:1.0 });
    if (!map.getLayer('sky')) {
      map.addLayer({
        id:'sky', type:'sky',
        paint:{ 'sky-type':'atmosphere','sky-atmosphere-sun':[0,0],'sky-atmosphere-sun-intensity':10 }
      });
    }
  } catch(e){}

  add3DBuildingsIfMissing();
  ensurePoiSourceLayer();
  updateViewInfo();
});

/* Tambah 3D building layer kalau belum ada (menggunakan composite/building) */
function add3DBuildingsIfMissing(){
  if (map.getLayer('3d-buildings')) return;
  // cari label layer agar extrusion berada di bawah label
  const layers = map.getStyle().layers;
  let labelLayerId;
  for (const l of layers) if (l.type==='symbol' && l.layout && l.layout['text-field']) { labelLayerId = l.id; break; }

  const heightExpr = [
    'coalesce',
    ['to-number', ['get','height']],
    ['*', ['to-number', ['coalesce', ['get','levels'], ['get','building:levels'], 0]], 3]
  ];

  map.addLayer({
    id:'3d-buildings',
    source:'composite',
    'source-layer':'building',
    filter:['==',['get','extrude'],'true'],
    type:'fill-extrusion',
    minzoom:14,
    paint:{
      'fill-extrusion-color':'#9aa6b2',
      'fill-extrusion-height': ['case', ['>=',heightExpr,1], heightExpr, 0],
      'fill-extrusion-base': ['coalesce', ['to-number', ['get','min_height']], 0],
      'fill-extrusion-opacity': 0.92
    }
  }, labelLayerId);
}

/* =========================
   POI STORAGE & LAYER
   ========================= */
let poiFeatures = [];                   // array of GeoJSON Features (Point)
const poiIndex = new Set();             // lon,lat string to avoid duplicates
const POI_SOURCE_ID = 'poi-src';
const POI_LAYER_ID  = 'poi-layer';

function ensurePoiSourceLayer(){
  if (!map.getSource(POI_SOURCE_ID)) {
    map.addSource(POI_SOURCE_ID, {
      type:'geojson',
      data: { type:'FeatureCollection', features:[] }
    });
  }
  if (!map.getLayer(POI_LAYER_ID)) {
    map.addLayer({
      id: POI_LAYER_ID,
      type:'symbol',
      source: POI_SOURCE_ID,
      layout:{
        'icon-image': 'marker-15',
        'icon-size': 1.1,
        'text-field': ['coalesce', ['get','name'], 'POI'],
        'text-size': 11,
        'text-offset': [0, 1.1],
        'text-anchor': 'top'
      },
      paint:{
        'text-halo-color': '#111',
        'text-halo-width': 1.2,
        'text-color': '#ffffff'
      }
    });
  }
}

function refreshPoiLayer(){
  const src = map.getSource(POI_SOURCE_ID);
  if (src) src.setData({ type:'FeatureCollection', features: poiFeatures });
  document.getElementById('poiCount').textContent = String(poiFeatures.length);
  renderPreviewTable();
}

/* Buat key unik untuk hindari duplikat (pembulatan 7 desimal ~ ~1 cm–1 m) */
function keyLonLat(lon, lat){
  const a = Number(lon).toFixed(7);
  const b = Number(lat).toFixed(7);
  return `${a},${b}`;
}

/* =========================
   GENERATE POI DARI OSM BUILDINGS (VIEW)
   ========================= */
function generatePOIFromBuildingsInView(){
  add3DBuildingsIfMissing();

  // Ambil semua fitur building yang sedang dirender (yg ada extrude=true)
  const feats = map.queryRenderedFeatures({ layers: ['3d-buildings'] });
  if (!feats || feats.length===0) {
    alert('Tidak ada bangunan yang dirender di view saat ini. Coba perbesar zoom atau geser ke area dengan bangunan.');
    return;
  }

  let added = 0;
  for (const f of feats) {
    if (!f.geometry) continue;
    try {
      const center = turf.centerOfMass({ type:'Feature', geometry:f.geometry, properties:{} });
      if (!center || !center.geometry) continue;
      const [lon, lat] = center.geometry.coordinates;

      // Hindari POI di luar canvas (kadang feature besar di tepian)
      const pt = map.project([lon,lat]);
      const canvas = map.getCanvas();
      if (pt.x < 0 || pt.y < 0 || pt.x > canvas.width || pt.y > canvas.height) continue;

      const name = f.properties?.name || null;
      const type = f.properties?.type || f.properties?.building || null;
      const height = resolveHeight(f.properties);

      const key = keyLonLat(lon, lat);
      if (poiIndex.has(key)) continue; // skip duplikat

      poiIndex.add(key);
      poiFeatures.push({
        type:'Feature',
        geometry:{ type:'Point', coordinates:[lon, lat] },
        properties:{
          id: makeId(),
          name: name || '',
          type: type || 'building',
          height: isFinite(height)? Number(height) : null,
          source: 'osmb(centerOfMass)'
        }
      });
      added++;
    } catch(e){}
  }

  refreshPoiLayer();
  if (added===0) {
    alert('POI tidak bertambah (mungkin sudah pernah diambil untuk area ini).');
  }
}

function resolveHeight(props={}){
  const h = Number(props.height);
  if (isFinite(h) && h>0) return h;
  const lv = Number(props.levels || props['building:levels']);
  if (isFinite(lv) && lv>0) return lv*3;
  return null;
}

function makeId(){ return Math.random().toString(36).slice(2,8) + Date.now().toString(36).slice(-4); }

/* =========================
   EXPORTERS
   ========================= */
function exportXLSX(){
  const rows = poiFeatures.map((ft,i)=>({
    id: ft.properties?.id || i+1,
    name: ft.properties?.name || '',
    type: ft.properties?.type || '',
    height: ft.properties?.height ?? '',
    lon: ft.geometry.coordinates[0],
    lat: ft.geometry.coordinates[1],
    source: ft.properties?.source || ''
  }));
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'POI');
  XLSX.writeFile(wb, 'poi_from_osmb.xlsx');
}

function exportCSV(){
  const rows = poiFeatures.map((ft,i)=>({
    id: ft.properties?.id || i+1,
    name: ft.properties?.name || '',
    type: ft.properties?.type || '',
    height: ft.properties?.height ?? '',
    lon: ft.geometry.coordinates[0],
    lat: ft.geometry.coordinates[1],
    source: ft.properties?.source || ''
  }));
  const ws = XLSX.utils.json_to_sheet(rows);
  const csv = XLSX.utils.sheet_to_csv(ws);
  downloadBlob(csv, 'poi_from_osmb.csv', 'text/csv;charset=utf-8;');
}

function exportGeoJSON(){
  const gj = { type:'FeatureCollection', features: poiFeatures };
  const json = JSON.stringify(gj);
  downloadBlob(json, 'poi_from_osmb.geojson', 'application/geo+json');
}

function downloadBlob(content, filename, type){
  const blob = new Blob([content], {type});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

/* =========================
   IMPORT XLSX
   ========================= */
async function importXLSX(file){
  const data = await file.arrayBuffer();
  const wb = XLSX.read(data);
  const first = wb.SheetNames[0];
  const ws = wb.Sheets[first];
  const json = XLSX.utils.sheet_to_json(ws, { defval: '' });

  let added = 0;
  for (const row of json) {
    const lon = Number(row.lon ?? row.longitude ?? row.x ?? row.lng);
    const lat = Number(row.lat ?? row.latitude ?? row.y);
    if (!isFinite(lon) || !isFinite(lat)) continue;
    const key = keyLonLat(lon, lat);
    if (poiIndex.has(key)) continue;

    poiIndex.add(key);
    poiFeatures.push({
      type:'Feature',
      geometry:{ type:'Point', coordinates:[lon, lat] },
      properties:{
        id: String(row.id || makeId()),
        name: String(row.name || ''),
        type: String(row.type || ''),
        height: row.height!=='' ? Number(row.height) : null,
        source: String(row.source || 'import(xlsx)')
      }
    });
    added++;
  }
  refreshPoiLayer();
  alert(`Import selesai. Ditambahkan: ${added} POI.`);
}

/* =========================
   TABLE PREVIEW (TOP 10)
   ========================= */
function renderPreviewTable(){
  const tbody = document.querySelector('#poiTable tbody');
  tbody.innerHTML = '';
  const top = poiFeatures.slice(0,10);
  top.forEach((ft, i)=>{
    const tr = document.createElement('tr');
    const p = ft.properties || {};
    const [lon,lat] = ft.geometry.coordinates;
    tr.innerHTML = `
      <td>${i+1}</td>
      <td title="${p.name||''}">${(p.name||'')}</td>
      <td>${p.type||''}</td>
      <td>${(p.height??'')}</td>
      <td>${lon.toFixed(6)}</td>
      <td>${lat.toFixed(6)}</td>`;
    tr.style.cursor='pointer';
    tr.onclick = ()=> map.easeTo({ center:[lon,lat], zoom:18, pitch:60, bearing:map.getBearing() });
    tbody.appendChild(tr);
  });
}

/* =========================
   UI HOOKS
   ========================= */
document.getElementById('genPoiBtn').addEventListener('click', generatePOIFromBuildingsInView);
document.getElementById('expXlsxBtn').addEventListener('click', exportXLSX);
document.getElementById('expCsvBtn').addEventListener('click', exportCSV);
document.getElementById('expGeoJsonBtn').addEventListener('click', exportGeoJSON);
document.getElementById('clearBtn').addEventListener('click', ()=>{
  if (!confirm('Hapus semua POI?')) return;
  poiFeatures = [];
  poiIndex.clear();
  refreshPoiLayer();
});

document.getElementById('impXlsxInput').addEventListener('change', (e)=>{
  const f = e.target.files?.[0];
  if (f) importXLSX(f);
  e.target.value = '';
});

map.on('moveend', updateViewInfo);
function updateViewInfo(){
  const b = map.getBounds();
  const dx = (b.getEast()-b.getWest()).toFixed(4);
  const dy = (b.getNorth()-b.getSouth()).toFixed(4);
  document.getElementById('viewInfo').textContent = `Δlon ${dx} • Δlat ${dy}`;
}
</script>
</body>
</html>
