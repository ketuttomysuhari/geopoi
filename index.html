<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>MyMap POI • Excel Import/Export + AOI Manual + OSM + Geo-AI Rumah</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet & Leaflet.Draw -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <!-- SheetJS (Excel) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Turf.js (geoprocessing) -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>

  <!-- FileSaver (untuk ekspor file di browser) -->
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <style>
    html, body, #map { height:100%; margin:0; }
    .panel {
      position:absolute; z-index:1000; top:10px; left:10px;
      background:rgba(20,20,24,.92); color:#fff; padding:12px 14px;
      border-radius:12px; font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      box-shadow:0 8px 24px rgba(0,0,0,.25); max-width: 420px;
    }
    .panel h3 { margin:0 0 8px; font-size:16px; }
    .panel .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:8px; }
    .panel input[type="file"], .panel input[type="text"], .panel textarea { width:100%; }
    .panel input[type="text"], .panel textarea {
      background:#121317; border:1px solid #2a2d36; color:#fff; border-radius:10px;
      padding:8px 10px; outline:none;
    }
    .panel textarea { min-height:60px; resize:vertical }
    .panel label { font-weight:600; display:block }
    .panel small { opacity:.8 }
    .panel button {
      border:0; padding:8px 10px; border-radius:10px; cursor:pointer;
      background:#2d6cdf; color:#fff; font-weight:600;
    }
    .panel button.secondary{ background:#444; }
    .panel button.warn{ background:#d94848; }
    .legend {
      position:absolute; right:10px; bottom:10px; z-index:1000;
      background:rgba(255,255,255,.95); color:#111; padding:10px 12px; border-radius:10px;
      box-shadow:0 8px 24px rgba(0,0,0,.15); font: 13px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    .legend .k { display:flex; gap:8px; align-items:center; margin:6px 0; }
    .legend .dot { width:12px; height:12px; border-radius:50% }
    .dot.poi { background:#2d6cdf }
    .dot.ai { background:#22a06b }
    .dot.bld { background:#a278ff }
    .dot.aoi { background:#ffa600 }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <h3>MyMap – POI, AOI, OSM & Geo-AI</h3>

    <!-- AOI dari koordinat manual -->
    <div class="row" style="width:100%">
      <label>Buat AOI dari Koordinat (lat,lon; lat,lon; ...)</label>
      <textarea id="coordsInput" placeholder="Contoh:
3.1569,101.7098;3.1578,101.7170;3.1612,101.7160;3.1602,101.7092"></textarea>
      <div style="display:flex; gap:8px; width:100%">
        <button id="addAoiBtn" class="secondary" title="Tambah polygon AOI dari daftar koordinat">Tambah AOI</button>
        <input id="bboxInput" type="text" placeholder="atau BBOX: minLon,minLat,maxLon,maxLat (opsional)">
        <button id="addBboxBtn" class="secondary" title="Tambah rectangle dari BBOX">Tambah AOI dari BBOX</button>
      </div>
      <small>Tips: minimal 3 titik untuk polygon. Format decimal degrees. BBOX contoh: <i>101.71,3.155,101.72,3.165</i></small>
    </div>

    <!-- Impor/ekspor -->
    <div class="row">
      <label><b>Impor Excel (.xlsx)</b></label>
      <input id="xlsxInput" type="file" accept=".xlsx,.xls" />
    </div>
    <div class="row">
      <button id="exportCsvBtn">Ekspor CSV</button>
      <button id="exportGeoBtn" class="secondary">Ekspor GeoJSON</button>
    </div>

    <!-- OSM & Geo-AI -->
    <div class="row">
      <button id="fetchOSMBtn">Ambil Bangunan OSM (dalam AOI)</button>
      <button id="genHouseBtn">Geo-AI: Titik Rumah</button>
    </div>

    <!-- Bersihkan -->
    <div class="row">
      <button id="clearAOIBtn" class="secondary">Bersihkan AOI</button>
      <button id="clearPOIBtn" class="secondary">Bersihkan POI Excel</button>
      <button id="clearBldBtn" class="secondary">Bersihkan Bangunan</button>
      <button id="clearAIBtn" class="secondary">Bersihkan Titik Rumah</button>
      <button id="clearDrawBtn" class="warn">Bersihkan Gambar</button>
    </div>

    <div class="row" style="margin-top:-2px">
      <small>
        1) Gambar atau input AOI → 2) “Ambil Bangunan OSM” → 3) “Geo-AI: Titik Rumah” →
        4) Impor Excel POI → 5) Ekspor CSV/GeoJSON
      </small>
    </div>
  </div>

  <div class="legend">
    <div class="k"><span class="dot aoi"></span> AOI (gambar / input koordinat)</div>
    <div class="k"><span class="dot bld"></span> Footprint Bangunan OSM</div>
    <div class="k"><span class="dot ai"></span> Titik Rumah (Geo-AI)</div>
    <div class="k"><span class="dot poi"></span> POI dari Excel / Manual</div>
  </div>

<script>
  // ====== PETA & LAYER DASAR ======
  const map = L.map('map', { center:[3.1579, 101.7116], zoom: 15 }); // KLCC default

  const esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: '&copy; Esri'
  }).addTo(map);

  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'&copy; OpenStreetMap'
  });

  const drawnItems = new L.FeatureGroup(); // garis/polygon/point yang digambar
  map.addLayer(drawnItems);

  const aoiLayer = L.layerGroup().addTo(map);           // AOI dari input manual
  const poiExcelLayer = L.layerGroup().addTo(map);      // marker dari Excel
  const buildingLayer = L.geoJSON(null, {
    style: { color:'#7a5cff', weight:1, fillOpacity:0.25 }
  }).addTo(map);
  const housePointLayer = L.layerGroup().addTo(map);    // titik rumah hasil Geo-AI

  L.control.layers(
    { 'ESRI World Imagery': esri, 'OSM Streets': osm },
    {
      'AOI (Manual)': aoiLayer,
      'Drawn (Gambar)': drawnItems,
      'Bangunan OSM': buildingLayer,
      'Titik Rumah (AI)': housePointLayer,
      'POI Excel': poiExcelLayer
    },
    { collapsed: true }
  ).addTo(map);

  // ====== KONTROL DRAW ======
  const drawControl = new L.Control.Draw({
    draw: {
      polygon: { allowIntersection:false, showArea:true, shapeOptions:{ color:'#ffa600' } },
      rectangle: { shapeOptions:{ color:'#ffa600' } },
      polyline: true,
      circle: false,
      marker: true,
      circlemarker: false
    },
    edit: { featureGroup: drawnItems }
  });
  map.addControl(drawControl);

  map.on(L.Draw.Event.CREATED, e => {
    if ((e.layer instanceof L.Polygon) && !(e.layer instanceof L.Polyline)) {
      e.layer.setStyle?.({ color:'#ffa600' });
    }
    drawnItems.addLayer(e.layer);
  });

  // ====== UTIL ======
  const toFixed6 = n => Number(n).toFixed(6);

  function buildPopup(props) {
    const {
      Name='', Address='', City='', Status='',
      Latitude='', Longitude='', Photo=''
    } = props || {};
    const img = Photo ? `<div style="margin-top:6px"><img src="${Photo}" alt="" style="max-width:180px;border-radius:8px"/></div>` : '';
    return `
      <div style="min-width:220px">
        <b>${Name || '(tanpa nama)'}</b><br/>
        ${Address ? Address+'<br/>' : ''}${City ? City+'<br/>' : ''}
        ${Status ? '<i>Status: '+Status+'</i><br/>' : ''}
        ${Latitude && Longitude ? `<small>Lat,Lon: ${toFixed6(Latitude)}, ${toFixed6(Longitude)}</small><br/>` : ''}
        ${img}
      </div>
    `;
  }

  function markerDot(colorHex) {
    return L.divIcon({
      className: '',
      html: `<span style="
        display:inline-block;width:12px;height:12px;border-radius:50%;
        background:${colorHex};
        border:2px solid #fff; box-shadow:0 0 0 2px rgba(0,0,0,.25)
      "></span>`,
      iconSize:[12,12], iconAnchor:[6,6]
    });
  }
  const iconPOI = markerDot('#2d6cdf');
  const iconAI  = markerDot('#22a06b');

  function firstPolygonOrRectangle(groupOrLayer) {
    let found = null;
    const scan = lay => {
      if (!found && lay instanceof L.LayerGroup) lay.eachLayer(scan);
      else if (!found && (lay instanceof L.Polygon) && !(lay instanceof L.Polyline)) found = lay;
    };
    scan(groupOrLayer);
    return found;
  }

  // ====== AOI dari KOORDINAT MANUAL ======
  const coordsInput = document.getElementById('coordsInput');
  document.getElementById('addAoiBtn').onclick = () => {
    const val = coordsInput.value.trim();
    if (!val) return alert('Masukkan koordinat lat,lon; lat,lon; ...');

    try {
      const coords = val
        .split(';')
        .map(c => c.split(',').map(s => Number(s.trim())))
        .filter(a => a.length===2 && Number.isFinite(a[0]) && Number.isFinite(a[1]))
        .map(([lat, lon]) => [lat, lon]);

      if (coords.length < 3) return alert('Minimal 3 titik untuk polygon AOI.');
      const poly = L.polygon(coords, { color:'#ffa600', weight:2, fillOpacity:0.15 });
      aoiLayer.addLayer(poly);
      map.fitBounds(poly.getBounds(), { padding:[30,30] });
    } catch(e) {
      console.error(e);
      alert('Format salah! Gunakan: lat,lon;lat,lon;lat,lon');
    }
  };

  // ====== AOI dari BBOX ======
  document.getElementById('addBboxBtn').onclick = () => {
    const v = document.getElementById('bboxInput').value.trim();
    if (!v) return alert('Masukkan BBOX: minLon,minLat,maxLon,maxLat');
    const parts = v.split(',').map(s => Number(s.trim()));
    if (parts.length !== 4 || parts.some(n => !Number.isFinite(n))) {
      return alert('Format BBOX salah. Contoh: 101.71,3.155,101.72,3.165');
    }
    const [minLon, minLat, maxLon, maxLat] = parts;
    if (minLon>=maxLon || minLat>=maxLat) return alert('Nilai BBOX tidak valid.');

    const rect = L.polygon([
      [minLat, minLon],
      [minLat, maxLon],
      [maxLat, maxLon],
      [maxLat, minLon]
    ], { color:'#ffa600', weight:2, fillOpacity:0.15 });
    aoiLayer.addLayer(rect);
    map.fitBounds(rect.getBounds(), { padding:[30,30] });
  };

  // ====== IMPOR EXCEL ======
  const xlsxInput = document.getElementById('xlsxInput');
  xlsxInput.addEventListener('change', handleExcelImport);

  async function handleExcelImport(ev) {
    const file = ev.target.files[0];
    if (!file) return;

    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf, { type: 'array' });
    const sheetName = wb.SheetNames[0];
    const ws = wb.Sheets[sheetName];
    const rows = XLSX.utils.sheet_to_json(ws, { defval:'' });

    // Ekspektasi minimal: Name, Latitude, Longitude
    // Opsional: Address, City, Status, Photo
    poiExcelLayer.clearLayers();

    rows.forEach((r, idx) => {
      const lat = parseFloat(r.Latitude ?? r.lat ?? r.Lat ?? r.Y ?? r.y);
      const lon = parseFloat(r.Longitude ?? r.lon ?? r.Lon ?? r.X ?? r.x);
      if (Number.isFinite(lat) && Number.isFinite(lon)) {
        const props = {
          Name: r.Name ?? r.POI_Name ?? `POI ${idx+1}`,
          Address: r.Address ?? r.Alamat ?? '',
          City: r.City ?? r.Kota ?? '',
          Status: r.Status ?? '',
          Latitude: lat, Longitude: lon,
          Photo: r.Photo ?? r['Link Picture'] ?? ''
        };
        const m = L.marker([lat, lon], { icon: iconPOI }).bindPopup(buildPopup(props));
        m.feature = { type:'Feature', geometry:{ type:'Point', coordinates:[lon, lat] }, properties: props };
        poiExcelLayer.addLayer(m);
      }
    });

    if (poiExcelLayer.getLayers().length) {
      map.fitBounds(poiExcelLayer.getBounds(), { padding:[30,30] });
    } else {
      alert('Tidak ada baris valid (Latitude/Longitude) pada Excel.');
    }
  }

  // ====== EKSPOR CSV & GEOJSON ======
  document.getElementById('exportCsvBtn').onclick = () => {
    const rows = [];
    poiExcelLayer.eachLayer(m => {
      const p = (m.feature && m.feature.properties) || {};
      const ll = m.getLatLng();
      rows.push({
        Name: p.Name || '',
        Address: p.Address || '',
        City: p.City || '',
        Status: p.Status || '',
        Latitude: p.Latitude || (ll?.lat ?? ''),
        Longitude: p.Longitude || (ll?.lng ?? ''),
        Photo: p.Photo || ''
      });
    });
    if (!rows.length) { alert('Layer POI kosong.'); return; }

    const headers = Object.keys(rows[0]);
    const csv = [headers.join(',')].concat(
      rows.map(r => headers.map(h => {
        const val = (r[h] ?? '').toString().replace(/"/g,'""');
        return `"${val}"`;
      }).join(','))
    ).join('\n');

    const blob = new Blob([csv], { type:'text/csv;charset=utf-8' });
    saveAs(blob, 'poi_export.csv');
  };

  document.getElementById('exportGeoBtn').onclick = () => {
    const feats = [];
    poiExcelLayer.eachLayer(m => {
      const ll = m.getLatLng();
      const props = (m.feature && m.feature.properties) || {};
      feats.push({
        type:'Feature',
        geometry:{ type:'Point', coordinates:[ll.lng, ll.lat] },
        properties: props
      });
    });
    const fc = { type:'FeatureCollection', features:feats };
    const blob = new Blob([JSON.stringify(fc,null,2)], { type:'application/geo+json' });
    saveAs(blob, 'poi_export.geojson');
  };

  // ====== AMBIL BANGUNAN OSM via Overpass API (dalam AOI) ======
  document.getElementById('fetchOSMBtn').onclick = async () => {
    // Ambil AOI dari: 1) layer gambar (drawnItems) atau 2) AOI manual (aoiLayer) — prioritas: drawnItems
    let aoi = firstPolygonOrRectangle(drawnItems);
    if (!aoi) aoi = firstPolygonOrRectangle(aoiLayer);
    if (!aoi) { alert('Buat AOI dulu (gambar atau input koordinat/BBOX).'); return; }

    try {
      const polyLatLng = aoi.getLatLngs();
      // dukung polygon/rectangle standard: bisa jadi array bertingkat
      const ring = Array.isArray(polyLatLng[0]) ? polyLatLng[0] : polyLatLng;
      const overpassPoly = ring.map(pt => `${pt.lat} ${pt.lng}`).join(' ');
      const query = `
[out:json][timeout:60];
way(poly:"${overpassPoly}")["building"];
(._;>;);
out body;
`;
      const res = await fetch('https://overpass-api.de/api/interpreter', {
        method:'POST', body: query, headers:{ 'Content-Type':'text/plain' }
      });
      if (!res.ok) throw new Error('Overpass API error');
      const data = await res.json();

      const gj = osmtogeojson(data);
      buildingLayer.clearLayers();
      buildingLayer.addData(gj);

      if (buildingLayer.getLayers().length) {
        map.fitBounds(buildingLayer.getBounds(), { padding:[30,30] });
      } else {
        alert('Tidak ada bangunan OSM di AOI ini.');
      }
    } catch (e) {
      console.error(e);
      alert('Gagal ambil data OSM. Coba ulangi atau kecilkan AOI.');
    }
  };

  // Konverter OSM → GeoJSON sederhana (untuk way + nodes)
  function osmtogeojson(osm) {
    const nodes = new Map();
    (osm.elements||[]).forEach(el => {
      if (el.type === 'node') nodes.set(el.id, [el.lon, el.lat]);
    });
    const features = [];
    (osm.elements||[]).forEach(el => {
      if (el.type === 'way' && el.nodes && el.nodes.length >= 3) {
        const coords = el.nodes.map(id => nodes.get(id)).filter(Boolean);
        if (!coords.length) return;
        const first = coords[0];
        const last  = coords[coords.length-1];
        if (first[0] !== last[0] || first[1] !== last[1]) coords.push(first); // tutup ring
        features.push({
          type:'Feature',
          geometry:{ type:'Polygon', coordinates:[coords] },
          properties: el.tags || {}
        });
      }
    });
    return { type:'FeatureCollection', features };
  }

  // ====== GEO-AI: TITIK RUMAH (centroid-on-surface setiap bangunan) ======
  document.getElementById('genHouseBtn').onclick = () => {
    if (!buildingLayer.getLayers().length) { alert('Layer bangunan OSM kosong. Klik dulu "Ambil Bangunan OSM".'); return; }
    housePointLayer.clearLayers();

    const gj = buildingLayer.toGeoJSON();
    gj.features.forEach((f, i) => {
      if (f.geometry && (f.geometry.type === 'Polygon' || f.geometry.type === 'MultiPolygon')) {
        const pt = turf.pointOnFeature(f);
        const [lon, lat] = pt.geometry.coordinates;
        const props = {
          Name: f.properties?.name || `Rumah #${i+1}`,
          Source: 'OSM',
          Note: 'Titik pusat atap (centroid-on-surface)'
        };
        const m = L.marker([lat, lon], { icon: iconAI }).bindPopup(buildPopup({
          Name: props.Name, Status: props.Note, Latitude: lat, Longitude: lon
        }));
        m.feature = { type:'Feature', geometry:{ type:'Point', coordinates:[lon, lat] }, properties: props };
        housePointLayer.addLayer(m);
      }
    });

    if (housePointLayer.getLayers().length) {
      map.fitBounds(housePointLayer.getBounds(), { padding:[30,30] });
      alert(`Tercipta ${housePointLayer.getLayers().length} titik rumah.`);
    } else {
      alert('Tidak ada poligon bangunan valid.');
    }
  };

  // ====== BERSIHKAN ======
  document.getElementById('clearAOIBtn').onclick = () => aoiLayer.clearLayers();
  document.getElementById('clearPOIBtn').onclick = () => poiExcelLayer.clearLayers();
  document.getElementById('clearBldBtn').onclick = () => buildingLayer.clearLayers();
  document.getElementById('clearAIBtn').onclick = () => housePointLayer.clearLayers();
  document.getElementById('clearDrawBtn').onclick = () => drawnItems.clearLayers();
</script>
</body>
</html>
