<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SIGEO AI • POI + AOI Drawing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Mapbox GL -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.js"></script>
  <!-- Mapbox GL Draw -->
  <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.5.0/mapbox-gl-draw.css" rel="stylesheet"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.5.0/mapbox-gl-draw.js"></script>
  <!-- Turf -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #map{position:absolute;inset:0}

    .panel{
      position:absolute; z-index:10; right:12px; top:12px; width:400px; max-width:calc(100% - 24px);
      background:rgba(20,20,24,.95); color:#fff; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,.25);
      display:flex; flex-direction:column; overflow:hidden;
    }
    .panel-h{padding:10px 12px;font-weight:700;border-bottom:1px solid rgba(255,255,255,.08);display:flex;justify-content:space-between;align-items:center}
    .panel-b{padding:12px; font-size:13px}
    .row{display:flex; gap:8px; flex-wrap:wrap; margin:8px 0}
    .row > * { flex:1 }
    .btn{appearance:none;border:none;border-radius:8px;padding:8px 10px;font-weight:700;cursor:pointer;background:#22c55e;color:#052e16}
    .btn.secondary{background:#0ea5e9;color:#03202a}
    .btn.warn{background:#ef4444;color:#2d0707}
    .btn.dark{background:#374151;color:#d1d5db}
    .btn.outline{background:transparent;border:1px solid rgba(255,255,255,.25);color:#e5e7eb}
    .stat{display:flex;gap:12px;align-items:center;margin:6px 0}
    .stat b{font-size:16px}
    .hint{opacity:.85}
    table{width:100%; border-collapse:collapse; margin-top:8px; font-size:12px}
    th,td{border-bottom:1px solid rgba(255,255,255,.08); padding:6px 4px; text-align:left; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    th{opacity:.8}
    .small{font-size:11px; opacity:.8}
    .file{display:inline-block; padding:8px; border:1px dashed rgba(255,255,255,.2); border-radius:8px; text-align:center}

    /* Chat mini */
    .chat{position:absolute;left:12px;bottom:12px;width:360px;max-width:calc(100% - 24px);background:rgba(20,20,24,.95);
      color:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.25);display:flex;flex-direction:column;overflow:hidden;z-index:10}
    .chat-h{padding:10px 12px;font-weight:600;border-bottom:1px solid rgba(255,255,255,.08);display:flex;justify-content:space-between}
    .chat-b{padding:10px;height:160px;overflow:auto;font-size:12px}
    .msg{margin:6px 0}.msg.me{text-align:right}.msg .bub{display:inline-block;padding:8px 10px;border-radius:10px;max-width:90%}
    .msg.me .bub{background:#2563eb}.msg.bot .bub{background:#374151}
    .chat-i{display:flex;gap:6px;padding:8px;border-top:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.2)}
    .chat-i input{flex:1;padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:#0f172a;color:#fff}
    .chat-i button{padding:8px 12px;border:none;border-radius:8px;background:#22c55e;color:#052e16;font-weight:700}
    .badge{display:inline-block;padding:2px 6px;border-radius:6px;background:#0ea5e9;color:#03202a;font-weight:700;font-size:11px}
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <div class="panel-h">
      <span>SIGEO AI — POI + AOI</span>
      <span class="badge" id="viewInfo">view: 0×0</span>
    </div>
    <div class="panel-b">
      <div class="stat">
        <div>Total POI:</div><b id="poiCount">0</b>
        <div style="margin-left:auto">AOI:</div><b id="aoiCount">0</b>
      </div>

      <div class="row">
        <button class="btn" id="genPoiBtn">Generate POI from OSM Buildings (in view)</button>
      </div>

      <!-- AOI controls -->
      <div class="row">
        <button class="btn secondary" id="drawAoiBtn">AOI: Draw/Edit</button>
        <button class="btn outline" id="applyAoiBtn">Apply AOI Filter</button>
        <button class="btn dark" id="clearAoiBtn">Clear AOI</button>
      </div>

      <!-- Export/Import -->
      <div class="row">
        <button class="btn secondary" id="expXlsxBtn">Export XLSX</button>
        <button class="btn secondary" id="expCsvBtn">Export CSV</button>
        <button class="btn secondary" id="expGeoJsonBtn">Export GeoJSON</button>
      </div>
      <div class="row" style="align-items:center">
        <label class="file" style="flex:2">
          Import XLSX
          <input type="file" id="impXlsxInput" accept=".xlsx,.xls" style="display:none">
        </label>
        <button class="btn dark" id="clearBtn" style="flex:1">Clear POI</button>
      </div>

      <div class="hint small">Tips: gambar AOI (polygon/rectangle). Klik “Apply AOI Filter” untuk hanya menampilkan POI yang berada di dalam AOI.</div>

      <div style="margin-top:10px; font-weight:700">Preview (top 10 tampilan saat ini)</div>
      <table id="poiTable">
        <thead>
          <tr><th>#</th><th>Name</th><th>Type</th><th>Height</th><th>Lon</th><th>Lat</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Chat rule-based -->
  <div class="chat">
    <div class="chat-h"><span>AI (Rule-Based)</span><span class="badge">/help</span></div>
    <div class="chat-b" id="chatBody">
      <div class="msg bot"><div class="bub">
        Perintah: <i>generate</i>, <i>aoi apply</i>, <i>aoi clear</i>, <i>export csv|xlsx|geojson</i>, <i>clear</i>, <i>fly petronas</i>, <i>style satellite|dark|light|standard</i>, <i>help</i>.
      </div></div>
    </div>
    <div class="chat-i">
      <input id="chatInput" placeholder="Type command…" />
      <button id="send">Send</button>
    </div>
  </div>

<script>
mapboxgl.accessToken = 'pk.eyJ1Ijoia2V0dXR0b215c3VoYXJpIiwiYSI6ImNrZmdvOWNvazBtM3EycmxkcHF3eXc0OTgifQ.J6kVGmohIIwY-A0hmt0gtg';
const PETRONAS = [101.71186, 3.15776];

const map = new mapboxgl.Map({
  container: 'map',
  // supaya titik “mengikuti citra”, bisa ganti cepat ke satellite via chat: "style satellite"
  style: 'mapbox://styles/mapbox/standard',
  center: PETRONAS, zoom: 17.2, pitch: 72, bearing: 20, antialias: true, hash: true
});
map.addControl(new mapboxgl.NavigationControl({ visualizePitch:true }), 'top-right');
map.addControl(new mapboxgl.FullscreenControl(), 'top-right');
map.addControl(new mapboxgl.ScaleControl({ maxWidth: 120, unit: 'metric' }));

// --- Draw control (AOI) ---
const Draw = new MapboxDraw({
  displayControlsDefault:false,
  controls:{ polygon:true, trash:true, combine_features:false, uncombine_features:false },
  defaultMode:'simple_select'
});
map.addControl(Draw, 'top-left');

map.on('style.load', () => {
  // Terrain + sky
  try {
    if (!map.getSource('mapbox-dem')) {
      map.addSource('mapbox-dem',{ type:'raster-dem', url:'mapbox://mapbox.mapbox-terrain-dem-v1', tileSize:512 });
    }
    map.setTerrain({ source:'mapbox-dem', exaggeration:1.0 });
    if (!map.getLayer('sky')) {
      map.addLayer({ id:'sky', type:'sky',
        paint:{ 'sky-type':'atmosphere','sky-atmosphere-sun':[0,0],'sky-atmosphere-sun-intensity':10 }
      });
    }
  } catch(e){}

  ensure3DBuildingsLayer();
  ensurePoiSourcesAndLayers();
  updateViewInfo();
});

/* ========= Buildings (under points) ========= */
function ensure3DBuildingsLayer(){
  if (map.getLayer('3d-buildings')) return;
  const layers = map.getStyle().layers;
  let aboveId;
  for (const l of layers) if (l.type==='symbol' && l.layout && l.layout['text-field']) { aboveId = l.id; break; }
  const heightExpr = [
    'coalesce',
    ['to-number', ['get','height']],
    ['*', ['to-number', ['coalesce', ['get','levels'], ['get','building:levels'], 0]], 3]
  ];
  map.addLayer({
    id:'3d-buildings',
    source:'composite',
    'source-layer':'building',
    type:'fill-extrusion',
    minzoom:14,
    paint:{
      'fill-extrusion-color':'#9aa6b2',
      'fill-extrusion-height': ['case', ['>=',heightExpr,1], heightExpr, 0],
      'fill-extrusion-base': ['coalesce', ['to-number', ['get','min_height']], 0],
      'fill-extrusion-opacity': 0.9
    }
  }, aboveId);
}

/* ========= Helpers ========= */
function waitForIdleOnce() {
  return new Promise(resolve => { map.once('idle', resolve); map.triggerRepaint && map.triggerRepaint(); });
}
function keyLonLat(lon, lat){ return `${Number(lon).toFixed(7)},${Number(lat).toFixed(7)}`; }
function makeId(){ return Math.random().toString(36).slice(2,8) + Date.now().toString(36).slice(-4); }

/* ========= Sources/Layers for POI (all + filtered) ========= */
let poiAll = [];               // semua POI hasil generate
const poiIndex = new Set();    // anti duplikat
let aoiGeom = null;            // GeoJSON geometry (Polygon/MultiPolygon)
let aoiFilterOn = false;

const SRC_POI_ALL = 'poi-all-src';
const SRC_POI_AOI = 'poi-aoi-src';
const LYR_POI_DOTS_ALL = 'poi-dots-all';
const LYR_POI_LABEL_ALL= 'poi-label-all';
const LYR_POI_DOTS_AOI = 'poi-dots-aoi';
const LYR_POI_LABEL_AOI= 'poi-label-aoi';

function ensurePoiSourcesAndLayers(){
  // sources
  if (!map.getSource(SRC_POI_ALL)) map.addSource(SRC_POI_ALL, { type:'geojson', data: fc([]) });
  if (!map.getSource(SRC_POI_AOI)) map.addSource(SRC_POI_AOI, { type:'geojson', data: fc([]) });

  const above = '3d-buildings'; // points above buildings
  // ALL - circle
  if (!map.getLayer(LYR_POI_DOTS_ALL)) map.addLayer({
    id: LYR_POI_DOTS_ALL, type:'circle', source:SRC_POI_ALL,
    paint:{
      'circle-radius': 4.5,
      'circle-color': '#00e5a8',
      'circle-stroke-color': '#03201a',
      'circle-stroke-width': 1.2
    }
  }, above);
  // ALL - label
  if (!map.getLayer(LYR_POI_LABEL_ALL)) map.addLayer({
    id: LYR_POI_LABEL_ALL, type:'symbol', source:SRC_POI_ALL,
    layout:{ 'text-field':['coalesce',['get','name'],'POI'], 'text-size':11, 'text-offset':[0,1.1], 'text-anchor':'top' },
    paint:{ 'text-color':'#ffffff', 'text-halo-color':'#111', 'text-halo-width':1.2 }
  }, LYR_POI_DOTS_ALL);

  // AOI - circle
  if (!map.getLayer(LYR_POI_DOTS_AOI)) map.addLayer({
    id: LYR_POI_DOTS_AOI, type:'circle', source:SRC_POI_AOI,
    layout:{ 'visibility':'none' },
    paint:{
      'circle-radius': 5.2,
      'circle-color': '#ffd166',
      'circle-stroke-color': '#2b1900',
      'circle-stroke-width': 1.4
    }
  }, LYR_POI_LABEL_ALL);
  // AOI - label
  if (!map.getLayer(LYR_POI_LABEL_AOI)) map.addLayer({
    id: LYR_POI_LABEL_AOI, type:'symbol', source:SRC_POI_AOI,
    layout:{ 'text-field':['coalesce',['get','name'],'POI'], 'text-size':12, 'text-offset':[0,1.2], 'text-anchor':'top', 'visibility':'none' },
    paint:{ 'text-color':'#fff7e6', 'text-halo-color':'#2b1900', 'text-halo-width':1.4 }
  }, LYR_POI_DOTS_AOI);
}

function fc(features){ return { type:'FeatureCollection', features }; }
function setSourceData(id, features){ const s = map.getSource(id); if (s) s.setData(fc(features)); }
function refreshCounters(visibleList){
  document.getElementById('poiCount').textContent = String(poiAll.length);
  document.getElementById('aoiCount').textContent = String(visibleList.length);
  renderPreviewTable(visibleList.slice(0,10));
}

/* ========= Building features from vector tiles ========= */
function getBuildingsInView(){
  let feats = [];
  try { feats = map.querySourceFeatures('composite', { sourceLayer:'building' }) || []; }
  catch(e){ feats = map.queryRenderedFeatures(); }
  const b = map.getBounds();
  const vp = turf.bboxPolygon([b.getWest(), b.getSouth(), b.getEast(), b.getNorth()]);
  return feats.filter(f=>{
    const g = f.geometry; if (!g || (g.type!=='Polygon' && g.type!=='MultiPolygon')) return false;
    const p = f.properties||{};
    const looksBuilding = ('building'in p)||('type'in p)||('height'in p)||('levels'in p)||('building:levels'in p);
    if (!looksBuilding) return false;
    try { return turf.booleanIntersects({type:'Feature',geometry:g,properties:{}}, vp); }
    catch(_){ return true; }
  });
}
function safeCenterPoint(geom){
  try { return turf.centerOfMass({type:'Feature',geometry:geom}); }
  catch(e){ try { return turf.pointOnFeature({type:'Feature',geometry:geom}); } catch(e2){ return null; } }
}
function resolveHeight(props){
  const h = Number(props?.height); if (isFinite(h)&&h>0) return h;
  const lv = Number(props?.levels || props?.['building:levels']);
  return (isFinite(lv)&&lv>0) ? lv*3 : null;
}

/* ========= Generate POI ========= */
async function generatePOIFromOSMB(){
  await waitForIdleOnce();
  const feats = getBuildingsInView();
  if (!feats.length){ alert('Tidak ada bangunan di view. Zoom ≥14 atau pindah area.'); return; }

  let added=0, canvas = map.getCanvas();
  for (const f of feats){
    const c = safeCenterPoint(f.geometry); if (!c) continue;
    const [lon,lat] = c.geometry.coordinates;
    const pt = map.project([lon,lat]); if (pt.x<0||pt.y<0||pt.x>canvas.width||pt.y>canvas.height) continue;

    const p=f.properties||{}, name=p.name||'', type=p.type||p.building||'', height=resolveHeight(p);
    const key = keyLonLat(lon,lat); if (poiIndex.has(key)) continue;

    poiIndex.add(key);
    poiAll.push({ type:'Feature', geometry:{type:'Point',coordinates:[lon,lat]},
      properties:{ id:makeId(), name, type, height:isFinite(height)?height:null, source:'osmb' } });
    added++;
  }
  setSourceData(SRC_POI_ALL, poiAll);
  applyAoiFilter(false); // refresh table using current mode
  if (!added) alert('POI tidak bertambah (kemungkinan area ini sudah disapu).');
}

/* ========= AOI handling ========= */
function getAoiFeature(){
  const all = Draw.getAll();
  if (!all.features.length) return null;
  if (all.features.length===1) return all.features[0];
  // jika banyak polygon, gabungkan (union sederhana pakai bbox clip; aman: cek per titik)
  return { type:'Feature', geometry: { type:'MultiPolygon', coordinates: all.features.map(f=>f.geometry.coordinates).flat() }, properties:{} };
}
function pointInAoi(ft){
  if (!aoiGeom) return true;
  try { return turf.booleanPointInPolygon(ft, aoiGeom); } catch(e){ return true; }
}
function getVisiblePoiList(){
  const list = aoiFilterOn && aoiGeom ? poiAll.filter(ft=>pointInAoi(ft)) : poiAll;
  return list;
}
function applyAoiFilter(toggle=true){
  if (toggle) aoiFilterOn = !aoiFilterOn;
  let visible = getVisiblePoiList();

  // tampilkan AOI-poi layer saat filter on
  const vis = aoiFilterOn ? 'visible' : 'none';
  map.setLayoutProperty(LYR_POI_DOTS_AOI, 'visibility', vis);
  map.setLayoutProperty(LYR_POI_LABEL_AOI,'visibility', vis);

  // set data
  if (aoiFilterOn){
    setSourceData(SRC_POI_AOI, visible);
    // sembunyikan layer ALL agar fokus ke AOI
    map.setLayoutProperty(LYR_POI_DOTS_ALL, 'visibility', 'none');
    map.setLayoutProperty(LYR_POI_LABEL_ALL,'visibility', 'none');
    // tone-down buildings
    map.setPaintProperty('3d-buildings', 'fill-extrusion-opacity', 0.7);
  } else {
    // tampilkan ALL kembali
    map.setLayoutProperty(LYR_POI_DOTS_ALL, 'visibility', 'visible');
    map.setLayoutProperty(LYR_POI_LABEL_ALL,'visibility', 'visible');
    setSourceData(SRC_POI_AOI, []); // kosongkan
    map.setPaintProperty('3d-buildings', 'fill-extrusion-opacity', 0.9);
  }
  refreshCounters(visible);
}

/* ========= Export / Import ========= */
function rowsFrom(list){
  return list.map((ft,i)=>({
    id: ft.properties?.id || i+1,
    name: ft.properties?.name || '',
    type: ft.properties?.type || '',
    height: ft.properties?.height ?? '',
    lon: ft.geometry.coordinates[0],
    lat: ft.geometry.coordinates[1],
    source: ft.properties?.source || ''
  }));
}
function exportXLSX(){ const list=getVisiblePoiList(); const ws=XLSX.utils.json_to_sheet(rowsFrom(list)); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'POI'); XLSX.writeFile(wb,'poi_visible.xlsx'); }
function exportCSV(){  const list=getVisiblePoiList(); const ws=XLSX.utils.json_to_sheet(rowsFrom(list)); const csv=XLSX.utils.sheet_to_csv(ws); downloadBlob(csv,'poi_visible.csv','text/csv;charset=utf-8;'); }
function exportGeoJSON(){ const list=getVisiblePoiList(); downloadBlob(JSON.stringify(fc(list)),'poi_visible.geojson','application/geo+json'); }
function downloadBlob(content, filename, type){ const blob=new Blob([content],{type}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url); }
async function importXLSX(file){
  const data = await file.arrayBuffer(); const wb=XLSX.read(data); const ws=wb.Sheets[wb.SheetNames[0]]; const json=XLSX.utils.sheet_to_json(ws,{defval:''});
  let added=0;
  for (const r of json){
    const lon=Number(r.lon??r.longitude??r.x??r.lng), lat=Number(r.lat??r.latitude??r.y);
    if (!isFinite(lon)||!isFinite(lat)) continue;
    const key=keyLonLat(lon,lat); if (poiIndex.has(key)) continue;
    poiIndex.add(key);
    poiAll.push({type:'Feature',geometry:{type:'Point',coordinates:[lon,lat]},properties:{
      id:String(r.id||makeId()), name:String(r.name||''), type:String(r.type||''), height:r.height!==''?Number(r.height):null, source:String(r.source||'import(xlsx)')}
    });
    added++;
  }
  setSourceData(SRC_POI_ALL, poiAll);
  applyAoiFilter(false);
  alert(`Import selesai. Ditambahkan: ${added} POI.`);
}

/* ========= Table + UI ========= */
function renderPreviewTable(list){
  const tbody = document.querySelector('#poiTable tbody'); tbody.innerHTML='';
  list.forEach((ft,i)=>{
    const p=ft.properties||{}, [lon,lat]=ft.geometry.coordinates;
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td title="${p.name||''}">${p.name||''}</td><td>${p.type||''}</td><td>${p.height??''}</td><td>${lon.toFixed(6)}</td><td>${lat.toFixed(6)}</td>`;
    tr.style.cursor='pointer'; tr.onclick=()=>map.easeTo({center:[lon,lat],zoom:18,pitch:60});
    tbody.appendChild(tr);
  });
}
document.getElementById('genPoiBtn').addEventListener('click', generatePOIFromOSMB);
document.getElementById('expXlsxBtn').addEventListener('click', exportXLSX);
document.getElementById('expCsvBtn').addEventListener('click', exportCSV);
document.getElementById('expGeoJsonBtn').addEventListener('click', exportGeoJSON);
document.getElementById('clearBtn').addEventListener('click', ()=>{
  if (!confirm('Hapus semua POI?')) return;
  poiAll=[]; poiIndex.clear();
  setSourceData(SRC_POI_ALL, poiAll); setSourceData(SRC_POI_AOI, []);
  aoiGeom=null; aoiFilterOn=false; map.setLayoutProperty(LYR_POI_DOTS_AOI,'visibility','none'); map.setLayoutProperty(LYR_POI_LABEL_AOI,'visibility','none');
  map.setLayoutProperty(LYR_POI_DOTS_ALL,'visibility','visible'); map.setLayoutProperty(LYR_POI_LABEL_ALL,'visibility','visible');
  refreshCounters(getVisiblePoiList());
});
document.getElementById('impXlsxInput').addEventListener('change', e=>{ const f=e.target.files?.[0]; if(f) importXLSX(f); e.target.value=''; });

document.getElementById('drawAoiBtn').addEventListener('click', ()=>{
  // toggle antara draw polygon dan select
  const mode = Draw.getMode();
  Draw.changeMode(mode==='draw_polygon' ? 'simple_select' : 'draw_polygon');
});
document.getElementById('applyAoiBtn').addEventListener('click', ()=>{
  aoiGeom = getAoiFeature()?.geometry || null;
  applyAoiFilter(true);
});
document.getElementById('clearAoiBtn').addEventListener('click', ()=>{
  Draw.deleteAll(); aoiGeom=null; if (aoiFilterOn) applyAoiFilter(true); // toggle off
});

map.on('draw.create', ()=>{ aoiGeom = getAoiFeature()?.geometry || null; });
map.on('draw.update', ()=>{ aoiGeom = getAoiFeature()?.geometry || null; });

map.on('moveend', updateViewInfo);
function updateViewInfo(){
  const b = map.getBounds();
  const dx = (b.getEast()-b.getWest()).toFixed(4);
  const dy = (b.getNorth()-b.getSouth()).toFixed(4);
  document.getElementById('viewInfo').textContent = `Δlon ${dx} • Δlat ${dy}`;
}

/* ========= Chat (rule-based) ========= */
const chatBody = document.getElementById('chatBody');
const chatInput= document.getElementById('chatInput');
const sendBtn  = document.getElementById('send');
function addMsg(t,who='bot'){ const d=document.createElement('div'); d.className=`msg ${who}`; d.innerHTML=`<div class="bub">${t}</div>`; chatBody.appendChild(d); chatBody.scrollTop=chatBody.scrollHeight; }
function parseCommand(s){
  const tl=s.trim().toLowerCase();
  if (tl==='help'||tl==='/help') return {a:'help'};
  if (tl==='generate') return {a:'gen'};
  if (tl==='clear') return {a:'clear'};
  if (tl==='aoi apply') return {a:'aoi_apply'};
  if (tl==='aoi clear') return {a:'aoi_clear'};
  if (/^export\s+(csv|xlsx|geojson)$/.test(tl)) return {a:'export',fmt:tl.split(/\s+/)[1]};
  if (/^fly\s+petronas$/.test(tl)) return {a:'fly'};
  const m = tl.match(/^style\s+(satellite|dark|light|standard)$/); if (m) return {a:'style',v:m[1]};
  return {a:'unknown'};
}
function handleCommand(cmd){
  switch(cmd.a){
    case 'help': addMsg('generate | aoi apply | aoi clear | export csv|xlsx|geojson | clear | fly petronas | style satellite|dark|light|standard'); break;
    case 'gen': generatePOIFromOSMB(); addMsg('Generate POI dari bangunan di view…'); break;
    case 'aoi_apply': aoiGeom=getAoiFeature()?.geometry||null; applyAoiFilter(true); addMsg('AOI filter toggled.'); break;
    case 'aoi_clear': Draw.deleteAll(); aoiGeom=null; if (aoiFilterOn) applyAoiFilter(true); addMsg('AOI cleared.'); break;
    case 'clear':
      poiAll=[]; poiIndex.clear(); setSourceData(SRC_POI_ALL, poiAll); setSourceData(SRC_POI_AOI, []); aoiGeom=null; aoiFilterOn=false;
      map.setLayoutProperty(LYR_POI_DOTS_AOI,'visibility','none'); map.setLayoutProperty(LYR_POI_LABEL_AOI,'visibility','none');
      map.setLayoutProperty(LYR_POI_DOTS_ALL,'visibility','visible'); map.setLayoutProperty(LYR_POI_LABEL_ALL,'visibility','visible');
      refreshCounters(getVisiblePoiList()); addMsg('Semua POI dihapus.'); break;
    case 'export':
      if (cmd.fmt==='csv') exportCSV(); else if (cmd.fmt==='xlsx') exportXLSX(); else exportGeoJSON();
      addMsg(`Export ${cmd.fmt} dari tampilan saat ini.`); break;
    case 'fly':
      map.flyTo({ center: PETRONAS, zoom: 17.2, pitch: 72, bearing: 20, speed:0.6, curve:1.2 }); addMsg('Kamera ke Petronas.'); break;
    case 'style':
      const mapStyle = { satellite:'mapbox://styles/mapbox/satellite-streets-v12', dark:'mapbox://styles/mapbox/dark-v11', light:'mapbox://styles/mapbox/light-v11', standard:'mapbox://styles/mapbox/standard' }[cmd.v];
      map.setStyle(mapStyle);
      map.once('style.load', ()=>{ ensure3DBuildingsLayer(); ensurePoiSourcesAndLayers(); setSourceData(SRC_POI_ALL, poiAll); applyAoiFilter(false); });
      addMsg(`Style: ${cmd.v}.`); break;
    default: addMsg('Tidak paham. Ketik: help');
  }
}
function onSend(){ const t=chatInput.value.trim(); if(!t) return; addMsg(t,'me'); chatInput.value=''; handleCommand(parseCommand(t)); }
sendBtn.addEventListener('click', onSend);
chatInput.addEventListener('keydown', e=>{ if(e.key==='Enter') onSend(); });
</script>
</body>
</html>
